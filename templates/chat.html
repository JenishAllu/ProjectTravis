<!DOCTYPE html>
<html>
<head>
  <title>Banking Chat Assistance - Agent</title>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <style>
    /* --- Copied and adapted from chat_customer.html for dark/glow theme --- */
    :root {
        --primary-color: #00e0ff;
        --secondary-color: #232a34;
        --accent-color: #00e0ff;
        --received-color: #fff;
        --text-color: #fff;
        --background-color-light: #181c24;
        --background-color-dark: #232a34;
        --card-background: #232a34;
        --heading-color: #00e0ff;
        --glow-color-primary: #00e0ff;
        --glow-color-secondary: #b2fefa;
        --glow-strength: 0 0 16px #00e0ff99;
        --glow-strength-strong: 0 0 32px #00e0ffcc;
    }
    body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #181c24 60%, #232a34 100%);
        margin: 0;
        padding: 0;
    }
    /* Glowing navbar */
    .navbar {
        width: 100vw;
        height: 60px;
        background: linear-gradient(90deg, #181c24 60%, #232a34 100%);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 40px;
        box-sizing: border-box;
        box-shadow: 0 2px 16px 0 #00e0ff55;
        position: fixed;
        top: 0; left: 0; z-index: 100;
        animation: navFadeIn 1.2s cubic-bezier(.4,1.4,.6,1) 0.1s both;
        backdrop-filter: blur(6px);
    }
    @keyframes navFadeIn {
        from { opacity: 0; transform: translateY(-40px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .nav-title {
        font-size: 2em;
        font-weight: 700;
        letter-spacing: 0.04em;
        color: #00e0ff;
        text-shadow: 0 0 16px #00e0ff99, 0 0 4px #fff2;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: fadeInLeft 1.2s cubic-bezier(.4,1.4,.6,1) 0.2s both;
    }
    .nav-links {
        display: flex;
        gap: 32px;
        align-items: center;
    }
    .nav-link {
        color: #fff;
        text-decoration: none;
        font-size: 1.1em;
        font-weight: 500;
        padding: 8px 18px;
        border-radius: 8px;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 0 8px 2px #00e0ff44;
    }
    .nav-link:hover {
        background: #232a34;
        color: #00e0ff;
        box-shadow: 0 0 16px 2px #00e0ff99;
    }
    @keyframes fadeInLeft {
        from { opacity: 0; transform: translateX(-40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .container {
        margin-top: 80px;
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
        background: linear-gradient(135deg, #232a34 60%, #181c24 100%);
        border-radius: 22px;
        box-shadow: 0 8px 40px #00e0ff55, 0 2px 12px #000a;
        padding: 38px 38px 22px 38px;
        backdrop-filter: blur(6px);
        position: relative;
        display: flex;
        gap: 32px;
    }
    .container::before {
        content: "";
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        border-radius: 22px;
        background: radial-gradient(circle at 20% 20%, #00e0ff33 0%, transparent 60%),
                    radial-gradient(circle at 80% 80%, #00e0ff22 0%, transparent 70%);
        z-index: 0;
        pointer-events: none;
    }
    /* ...existing code... */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-bottom: 15px; /* Reduced margin */
      border-bottom: 1px solid #eee;
      padding-bottom: 10px; /* Reduced padding */
    }
    h2 {
      color: var(--text-color);
      margin: 0;
      font-size: 1.6em; /* Slightly reduced font size */
    }
    .branding-footer {
        font-size: 0.75em; /* Slightly smaller font */
        color: var(--secondary-color);
        margin-top: 15px; /* Reduced margin */
        text-align: center;
        width: 100%;
    }
    a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    a:hover {
      text-decoration: underline;
      color: #0056b3;
    }
    .customers-panel {
      flex: 0 0 250px;
      border: 2px solid #00e0ff;
      border-radius: 12px;
      padding: 16px 10px 10px 10px;
      background: linear-gradient(135deg, #232a34 60%, #181c24 100%);
      box-shadow: 0 4px 24px #00e0ff33, 0 1.5px 8px #00e0ff11;
      order: 1;
      color: #fff;
    }
    #customers {
      max-height: 300px; /* Significantly reduced height for more customers */
      overflow-y: auto;
      padding-right: 5px;
    }
    .customer {
      cursor: pointer;
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 8px;
      background: linear-gradient(90deg, #232a34 0%, #181c24 100%);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s;
      font-weight: 600;
      color: #00e0ff;
      box-shadow: 0 2px 8px #00e0ff22;
      border: 1.5px solid #00e0ff44;
      letter-spacing: 0.02em;
      text-shadow: 0 1px 8px #00e0ff88;
    }
    .customer:hover {
      background: linear-gradient(90deg, #00e0ff 0%, #b2fefa 100%);
      color: #181c24;
      box-shadow: 0 4px 16px #00e0ff55, 0 2px 8px #00e0ff22;
      transform: translateY(-2px);
      border: 1.5px solid #00e0ff;
      text-shadow: 0 0 8px #fff, 0 0 2px #00e0ff;
    }
    .customer.active {
      background: linear-gradient(90deg, #00e0ff 0%, #b2fefa 100%);
      color: #181c24;
      box-shadow: 0 4px 16px #00e0ffcc, 0 2px 8px #00e0ff44;
      border: 2px solid #00e0ff;
      text-shadow: 0 0 8px #fff, 0 0 2px #00e0ff;
    }
    .chat-panel {
      flex: 2 1 0%;
      min-width: 800px;
      max-width: 1000px;
      display: flex;
      flex-direction: column;
      border: 2.5px solid #00e0ff;
      border-radius: 18px;
      padding: 24px;
      background: linear-gradient(135deg, #232a34 60%, #181c24 100%);
      position: relative;
      box-shadow: 0 8px 32px #00e0ff44, 0 2px 12px #00e0ff22;
      order: 2;
      margin: 0 auto;
      min-height: 600px;
      height: 70vh;
      color: #fff;
    }
    .chat-header-row { /* New class for the row containing heading and clear chat */
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px; /* Reduced margin */
    }
    #chat {
      flex-grow: 1;
      min-height: 400px;
      max-height: 60vh;
      overflow-y: auto;
      margin-bottom: 16px;
      padding: 18px 16px;
      border: 2px solid #00e0ff;
      border-radius: 16px;
      background: linear-gradient(135deg, #232a34 60%, #181c24 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 8px 32px #00e0ff44, 0 2px 12px #00e0ff22;
      gap: 8px;
      scroll-behavior: smooth;
      color: #fff;
    }
    .message {
      margin: 10px 0;
      padding: 14px 22px;
      border-radius: 22px;
      max-width: 88%;
      word-wrap: break-word;
      font-size: 1.18em;
      box-shadow: 0 4px 24px #00e0ff33, 0 1.5px 8px #00e0ff11;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      color: #181c24;
    }
    .sent {
      background: linear-gradient(90deg, #00e0ff 0%, #b2fefa 100%);
      color: #181c24;
      align-self: flex-end;
      text-align: right;
      border-bottom-right-radius: 8px;
      border-top-right-radius: 22px;
      box-shadow: 0 0 24px #00e0ffcc, 0 2px 8px #00e0ff44;
    }
    .received {
      background: linear-gradient(90deg, #fff 0%, #e3e3e3 100%);
      color: #181c24;
      align-self: flex-start;
      text-align: left;
      border-bottom-left-radius: 8px;
      border-top-left-radius: 22px;
      box-shadow: 0 0 24px #fff8, 0 2px 8px #00e0ff33;
    }
    /* Removed ::after pseudo-elements as they are not needed with the new border-radius */
    .sent:hover, .received:hover {
        transform: translateY(-2px);
    }
    .message-input-area {
      display: flex;
      gap: 8px; /* Reduced gap */
      margin-top: 10px; /* Reduced margin */
    }
    #message {
      flex-grow: 1;
      padding: 8px 12px; /* Reduced padding */
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 0.95em; /* Slightly smaller font */
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    #message:focus {
        outline: none;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(0, 123, 255, 0.6);
    }
    button {
      padding: 8px 15px; /* Reduced padding */
      background: linear-gradient(45deg, var(--primary-color), #0056b3);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em; /* Slightly smaller font */
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      position: relative;
      overflow: hidden;
    }
    button:hover {
      background: linear-gradient(45deg, #0056b3, var(--primary-color));
      box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4), var(--glow-strength);
      transform: translateY(-2px);
    }
    button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
    }
    button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: rgba(255,255,255,0.15);
        border-radius: 50%;
        transition: all 0.75s ease-out;
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    button:hover::before {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    button.clear-chat-button {
      background: linear-gradient(45deg, #dc3545, #c82333); /* Red gradient */
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }
    button.clear-chat-button:hover {
      background: linear-gradient(45deg, #c82333, #dc3545);
      box-shadow: 0 6px 12px rgba(220, 53, 69, 0.4), var(--glow-strength); /* Red glow */
    }

    /* High-contrast box styles */
    .highlight-box {
      position: absolute;
      border: 3px solid var(--glow-color-primary); /* Primary glow color for high contrast */
      background-color: rgba(136, 221, 255, 0.2); /* Semi-transparent glow overlay */
      border-radius: 18px; /* Slightly more rounded than messages */
      pointer-events: none; /* Allow clicks to pass through to messages if needed */
      transition: all 0.1s ease-out; /* Smooth transition for movement */
      z-index: 10; /* Ensure it's above messages */
      box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }

    /* Heading icons */
    .heading-with-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-color);
        /* margin-bottom removed, now controlled by chat-header-row */
    }
    .heading-icon {
        width: 20px; /* Slightly smaller icons */
        height: 20px;
        fill: var(--primary-color);
    }

    /* Keyframe Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .container {
        max-width: 900px;
      }
      .customers-panel {
        flex: 0 0 200px;
      }
      .chat-panel {
        min-width: 500px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      h1 {
        font-size: 2em;
        margin-bottom: 15px;
      }
      .container {
        flex-direction: column;
        max-width: 100%;
        padding: 15px;
      }
      .customers-panel, .chat-panel {
        min-width: unset;
        width: 100%;
        order: unset;
        padding: 10px;
      }
      #customers, #chat {
        max-height: 200px; /* Adjust for smaller screens */
        height: 200px; /* Adjust for smaller screens */
      }
      .chat-header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      .message-input-area {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
      #message {
        width: calc(100% - 24px); /* Adjust for padding */
      }
    }
  </style>
</head>
<body>

  <!-- Top Navigation Bar (Glowing, Modern) -->
  <nav id="main-navbar" style="width:100%;background:#181f2a;box-shadow:0 2px 16px #4A90E299,0 2px 8px rgba(0,0,0,0.07);padding:0 0 0 0.5em;display:flex;align-items:center;justify-content:space-between;min-height:56px;margin-bottom:18px;border-radius:0 0 16px 16px;position:relative;z-index:10;">
    <div style="display:flex;align-items:center;gap:18px;">
      <span style="font-weight:700;font-size:1.3em;color:#88ddff;text-shadow:0 0 8px #4A90E2;letter-spacing:1px;">HERMES</span>
      <a href="#" id="about-link" style="color:#fff;font-weight:500;padding:6px 14px;border-radius:6px;text-decoration:none;transition:background 0.2s;box-shadow:0 0 8px #4A90E2AA;">About</a>
      <a href="https://github.com/JenishAllu/ProjectTravis" target="_blank" style="color:#fff;font-weight:500;padding:6px 14px;border-radius:6px;text-decoration:none;transition:background 0.2s;">GitHub</a>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <span style="font-weight:600;font-size:1.1em;color:#fff;">Agent: {{username}}</span>
      <a href="/logout" style="margin-right:1.5em;font-weight:500;color:#fff;background:#4A90E2;padding:8px 18px;border-radius:8px;text-decoration:none;transition:background 0.2s;box-shadow:0 0 8px #4A90E2AA;">Logout</a>
    </div>
  </nav>

  <!-- About Modal -->
  <div id="about-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:10000;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:16px;box-shadow:0 8px 32px #4A90E288;padding:32px 28px;max-width:420px;width:95vw;position:relative;">
      <button onclick="document.getElementById('about-modal').style.display='none'" style="position:absolute;top:12px;right:16px;background:none;border:none;font-size:1.5em;color:#4A90E2;cursor:pointer;">&times;</button>
      <h2 style="margin-top:0;color:#4A90E2;text-align:center;">About This Project</h2>
      <p style="color:#222;font-size:1.08em;">This is a modern, accessible live chat system for customer support, built with Flask, Socket.IO, and a focus on real-time feedback and accessibility for all agents.</p>
      <h3 style="margin-bottom:6px;color:#2c3e50;font-size:1.1em;">Keyboard Shortcuts</h3>
      <ul style="font-size:1em;color:#333;line-height:1.7;margin:0 0 10px 0;padding-left:18px;">
        <li><b>Ctrl + Shift + Space</b>: Hold to record (mic on while holding)</li>
        <li><b>Alt + S</b>: Send message</li>
        <li><b>Alt + L</b>: Read customer list</li>
        <li><b>Alt + C</b>: Read chat from bottom</li>
        <li><b>Left/Right Arrow</b>: Navigate chat messages</li>
      </ul>
      <div style="font-size:0.95em;color:#666;text-align:center;margin-top:10px;">Accessibility features: Speech feedback, keyboard navigation, and mic control for blind agents.</div>
    </div>
  </div>

  <div class="container">
    <!-- Customer List Panel -->
    <div class="customers-panel">
      <div class="heading-with-icon" style="margin-bottom:10px;">
        <svg class="heading-icon" viewBox="0 0 24 24">
            <circle cx="12" cy="8" r="4" fill="#4A90E2"/>
            <rect x="4" y="16" width="16" height="4" rx="2" fill="#b3e0ff"/>
        </svg>
        <h3 style="margin:0;">Online Customers</h3>
      </div>
      <div id="customers">
        {% for customer in customers %}
          <div class="customer" onclick="selectCustomer('{{ customer }}', this)">
            <span style="display:inline-block;width:10px;height:10px;background:#28c76f;border-radius:50%;margin-right:7px;vertical-align:middle;"></span>
            <img src="https://ui-avatars.com/api/?name={{customer}}&background=6c757d&color=fff&rounded=true&size=24" alt="{{customer}}" style="width:24px;height:24px;border-radius:50%;margin-right:7px;vertical-align:middle;">
            <span style="vertical-align:middle;">{{ customer }}</span>
          </div>
        {% else %}
          <p>No customers online.</p>
        {% endfor %}
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="chat-header-row" style="margin-bottom:18px;">
        <div class="heading-with-icon">
          <svg class="heading-icon" viewBox="0 0 24 24">
              <rect x="2" y="4" width="20" height="16" rx="4" fill="#4A90E2"/>
              <circle cx="8" cy="12" r="2" fill="#fff"/>
              <circle cx="16" cy="12" r="2" fill="#fff"/>
          </svg>
          <h3 style="margin:0;">Chat with: <span id="current-customer-display" style="color:#4A90E2;">None</span></h3>
        </div>
        <button class="clear-chat-button" onclick="clearChat()">Clear Chat</button>
      </div>
      <div id="chat" style="flex:1;min-height:350px;">
        <div id="highlight-box" class="highlight-box" style="display: none;"></div>
        <!-- Messages will be appended dynamically here -->
        <div id="chat-placeholder" style="display:flex;align-items:center;justify-content:center;height:100%;color:#b0b0b0;font-size:1.2em;">
          <span>Select a customer to start chatting.</span>
        </div>
      </div>

      <div class="message-input-area">
        <input id="message" placeholder="Type your message" onkeydown="checkEnter(event)" autocomplete="off">
        <button id="sendMessageButton" onclick="sendAgentMessage()" disabled title="Send (Enter)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9-21-9v7l15 2-15 2v7z" fill="#fff"/></svg>
        </button>
        <button id="micButton" disabled title="Record audio" style="background:#222;display:flex;align-items:center;justify-content:center;position:relative;">
          <span id="micIconWrapper" style="display:inline-flex;align-items:center;justify-content:center;">
            <svg id="micIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 0 8px #4A90E2AA);transition:filter 0.2s;">
              <path d="M12 15a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0m5 5v3m-4 0h8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
        <span id="recordingStatus" class="recording-status"></span>
      </div>
    </div>
  </div>
  <div class="branding-footer">Provided by Team Travis G242</div>

  <script>
    const socket = io();
    const username = "{{username}}";
    let currentRoom = "";
    let currentCustomer = "";
    const COLAB_URL = "https://9fe110d854d2.ngrok-free.app"; // Updated ngrok URL

    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioStream = null; // Initialize as null

    const micButton = document.getElementById('micButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const messageInput = document.getElementById('message');
    const currentCustomerDisplay = document.getElementById('current-customer-display');
    const sendMessageButton = document.getElementById('sendMessageButton');
    const chatBox = document.getElementById("chat");
    const customersPanel = document.getElementById("customers");


    // Text-to-speech and highlight box variables
    let currentMessageIndex = -1;
    let messagesData = []; // This will store the full message objects received from backend
    let speechTimeout;
    const highlightBox = document.getElementById('highlight-box');
    const SPEECH_DELAY = 1000; // 1 second

    // Request microphone access on page load
    window.onload = function() {
        requestMicrophoneAccess();
        // Setup keyboard navigation
        document.addEventListener('keydown', handleKeyboardNavigation);
    };

    async function requestMicrophoneAccess() {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            console.log("Microphone access granted.");
            micButton.disabled = false; // Enable mic button once permission is granted
        }
        catch (err) {
            console.error("Error accessing microphone:", err);
            recordingStatus.textContent = "Microphone access denied.";
            micButton.disabled = true;
        }
    }


    // --- Accessibility: Keyboard Shortcuts & Navigation ---
    let customerListFocused = false;
    let customerListIndex = -1;
    let customerElements = [];

    function focusMessageInput() {
      messageInput.focus();
    }
    function blurMessageInput() {
      messageInput.blur();
    }
    function focusCustomerList() {
      customerElements = Array.from(document.querySelectorAll('.customer'));
      if (customerElements.length > 0) {
        customerListFocused = true;
        customerListIndex = 0;
        updateCustomerListFocus();
        speakMessage(customerElements[0].textContent.trim(), 'en');
      }
    }
    // --- Real-time customer list update ---
    // Listen for customer_status events from backend
    socket.on('customer_status', function(data) {
      const { username, status } = data;
      const customersDiv = document.getElementById('customers');
      let customerDiv = Array.from(customersDiv.querySelectorAll('.customer')).find(div => div.textContent.trim() === username);
      if (status === 'online') {
        // Add customer if not present
        if (!customerDiv) {
          customerDiv = document.createElement('div');
          customerDiv.className = 'customer';
          customerDiv.onclick = function() { selectCustomer(username, customerDiv); };
          customerDiv.innerHTML = `<span style="display:inline-block;width:10px;height:10px;background:#28c76f;border-radius:50%;margin-right:7px;vertical-align:middle;"></span><img src="https://ui-avatars.com/api/?name=${username}&background=6c757d&color=fff&rounded=true&size=24" alt="${username}" style="width:24px;height:24px;border-radius:50%;margin-right:7px;vertical-align:middle;"><span style="vertical-align:middle;">${username}</span>`;
          customersDiv.appendChild(customerDiv);
        }
      } else if (status === 'offline') {
        // Remove customer if present
        if (customerDiv) {
          if (customerDiv.classList.contains('active')) {
            // If currently selected, clear chat
            selectCustomer('', null);
          }
          customerDiv.remove();
        }
      }
      // Update customerElements for keyboard navigation
      customerElements = Array.from(document.querySelectorAll('.customer'));
    });
    function blurCustomerList() {
      if (customerElements.length > 0 && customerListIndex >= 0) {
        customerElements[customerListIndex].classList.remove('keyboard-focus');
      }
      customerListFocused = false;
      customerListIndex = -1;
    }
    function updateCustomerListFocus() {
      customerElements.forEach((el, idx) => {
        if (idx === customerListIndex) {
          el.classList.add('keyboard-focus');
          el.scrollIntoView({block:'nearest'});
        } else {
          el.classList.remove('keyboard-focus');
        }
      });
    }

    document.addEventListener('keydown', function(e) {
      // About modal shortcut (Alt+A)
      if (e.altKey && e.key.toLowerCase() === 'a') {
        document.getElementById('about-modal').style.display = 'flex';
        e.preventDefault();
        return;
      }
      // Alt+S: Send message
      if (e.altKey && e.key.toLowerCase() === 's') {
        sendAgentMessage();
        e.preventDefault();
        return;
      }
      // Ctrl+Shift+Space: Start recording
      if (e.ctrlKey && e.shiftKey && e.code === 'Space' && !isRecording) {
        startRecordingInternal();
        e.preventDefault();
        return;
      }
      // Ctrl+Shift+Space: Stop recording if recording
      if (e.ctrlKey && e.shiftKey && e.code === 'Space' && isRecording) {
        stopRecordingInternal();
        e.preventDefault();
        return;
      }
      // Esc: blur message input or customer list
      if (e.key === 'Escape') {
        if (document.activeElement === messageInput) {
          blurMessageInput();
        }
        if (customerListFocused) {
          blurCustomerList();
        }
        return;
      }
      // Alt+L: Focus customer list and read first customer
      if (e.altKey && e.key.toLowerCase() === 'l') {
        focusCustomerList();
        if (customerElements.length > 0) {
          speakMessage(customerElements[0].textContent.trim(), 'en');
        }
        e.preventDefault();
        return;
      }
      // Customer list navigation (Up/Down/Enter)
      if (customerListFocused) {
        if (e.key === 'ArrowDown') {
          customerListIndex = Math.min(customerListIndex + 1, customerElements.length - 1);
          updateCustomerListFocus();
          speakMessage(customerElements[customerListIndex].textContent.trim(), 'en');
          e.preventDefault();
          return;
        }
        if (e.key === 'ArrowUp') {
          customerListIndex = Math.max(customerListIndex - 1, 0);
          updateCustomerListFocus();
          speakMessage(customerElements[customerListIndex].textContent.trim(), 'en');
          e.preventDefault();
          return;
        }
        if (e.key === 'Enter') {
          if (customerElements[customerListIndex]) {
            customerElements[customerListIndex].click();
            blurCustomerList();
            setTimeout(focusMessageInput, 100);
          }
          e.preventDefault();
          return;
        }
      }
      // Alt+M: Read current message (for both agent and customer)
      if (e.altKey && e.key.toLowerCase() === 'm') {
        if (currentMessageIndex >= 0 && currentMessageIndex < messagesData.length) {
            const msg = messagesData[currentMessageIndex];
            if (msg && msg.speech_text) {
                speakMessage(msg.speech_text, msg.message_lang || 'en');
            }
        } else if (messagesData.length > 0) {
            // If no message is selected, read the last message
            const msg = messagesData[messagesData.length - 1];
            if (msg && msg.speech_text) {
                speakMessage(msg.speech_text, msg.message_lang || 'en');
            }
        }
        e.preventDefault();
      }
    });
    // No need for keyup handler for recording
    // Add style for keyboard-focused customer
    const style = document.createElement('style');
    style.innerHTML = `.customer.keyboard-focus { outline: 3px solid #00e0ff; box-shadow: 0 0 0 4px #00e0ff44; }`;
    document.head.appendChild(style);

    // About link click
    document.getElementById('about-link').onclick = function(e) {
      document.getElementById('about-modal').style.display = 'flex';
      e.preventDefault();
    };

    micButton.addEventListener('click', toggleRecording);

    function toggleRecording() {
        if (currentRoom === "") {
            showMessageBox("Please select a customer chat first.");
            return;
        }

        if (!isRecording) {
            startRecordingInternal();
        } else {
            stopRecordingInternal();
        }
    }

    function startRecordingInternal() {
        if (!audioStream) {
            console.error("Audio stream not available. Microphone access might not be granted.");
            recordingStatus.textContent = "Microphone error. Try refreshing.";
            return;
        }

        audioChunks = []; // Clear previous audio chunks
        recordingStatus.textContent = "Recording...";
        isRecording = true;
        // Glowing mic icon
        document.getElementById('micIcon').style.filter = 'drop-shadow(0 0 16px #ffcc00) drop-shadow(0 0 32px #ffcc00)';

        // Use higher audio quality for better transcription
        let options = {};
        if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            options = { mimeType: 'audio/webm;codecs=opus', audioBitsPerSecond: 128000 };
        } else if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/webm')) {
            options = { mimeType: 'audio/webm', audioBitsPerSecond: 128000 };
        }
        mediaRecorder = new MediaRecorder(audioStream, options);
        mediaRecorder.ondataavailable = event => {
            if (event.data && event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const base64Audio = reader.result.split(',')[1];
                recordingStatus.textContent = "Processing...";
                // Send language hint for better ASR (if backend supports)
                socket.emit('transcribe_audio', { audio: base64Audio, room: currentRoom, lang: 'en' });
            };
        };
        mediaRecorder.start();
    }

    function stopRecordingInternal() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            // Restore mic icon glow
            document.getElementById('micIcon').style.filter = 'drop-shadow(0 0 8px #4A90E2AA)';
            // Do NOT stop audioStream tracks here; keep the stream alive for better quality
            // Only re-request mic if stream is lost
            if (!audioStream || audioStream.getTracks().every(track => track.readyState === 'ended')) {
                requestMicrophoneAccess();
            }
        }
    }

    socket.on('transcribed_text', data => {
        // Clean up transcription: remove extra whitespace, fix common artifacts
        let cleanText = (data.text || '').replace(/\s+/g, ' ').replace(/\s([?.!])/g, '$1').trim();
        messageInput.value = cleanText;
        recordingStatus.textContent = "Transcription complete.";
        // Accessibility: Speak out the transcribed text for blind agents
        if (cleanText.length > 0) {
          speakMessage(cleanText, 'en');
        }
    });

    function selectCustomer(customer, element) {
      // Remove active class from previous customer
      const currentActive = document.querySelector('.customer.active');
      if (currentActive) {
        currentActive.classList.remove('active');
      }
      // Add active class to clicked customer
      element.classList.add('active');

      currentCustomer = customer;
      currentRoom = "room_" + customer;
      currentCustomerDisplay.innerText = customer;

      // Hide chat placeholder when a customer is selected
      const chatPlaceholder = document.getElementById('chat-placeholder');
      if (chatPlaceholder) chatPlaceholder.style.display = 'none';

      // Only emit join; the 'history' event handler will clear and populate messages
      socket.emit('join', {username: username, room: currentRoom});

      // Enable send message button and mic button
      sendMessageButton.disabled = false;
      micButton.disabled = false;

      // Reset message navigation and hide highlight box
      currentMessageIndex = -1;
      messagesData = []; // Clear messages data when switching customers
      hideHighlightBox();
    }

    function sendAgentMessage() {
      if (currentRoom === "") {
        showMessageBox("Please select a customer chat first.");
        return;
      }
      const msg = document.getElementById("message").value.trim();
      if (msg === "") return;

      socket.emit('agent_message', {
        room: currentRoom,
        message: msg
      });
      document.getElementById("message").value = "";
    }

    function checkEnter(e) {
      if (e.key === 'Enter') {
        sendAgentMessage();
      }
    }

    socket.on('history', msgs => {
      // Hide chat placeholder when loading history
      const chatPlaceholder = document.getElementById('chat-placeholder');
      if (chatPlaceholder) chatPlaceholder.style.display = 'none';

      // Clear only the existing messages, preserve the highlight box
      // Iterate backwards to safely remove elements while looping
      const messagesInChat = chatBox.querySelectorAll('.message');
      for (let i = messagesInChat.length - 1; i >= 0; i--) {
          messagesInChat[i].remove();
      }

      messagesData = []; // Clear the array before populating from history
      msgs.forEach((m, index) => {
        messagesData.push(m); // Store the full message object

        let cls;
        // Agent's own messages (username) and AI messages ("AI:") should be on the right ("sent")
        // Customer messages (others) should be on the left ("received")
        if (m.sender === username || m.sender === 'Agent' || m.sender === 'AI') {
            cls = "sent message";
        } else {
            cls = "received message";
        }

        const div = document.createElement('div');
        div.className = cls;
        div.id = `msg-${index}`; // Assign a unique ID
        div.innerHTML = m.display_text; // Use display_text from the backend
        div.lang = m.message_lang; // Set the lang attribute for speech synthesis
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
      currentMessageIndex = -1; // Reset index after loading history
      hideHighlightBox(); // Ensure highlight box is hidden after loading history
    });

    socket.on('new_message', msg => {
      messagesData.push(msg); // Store the full new message object

      let cls;
      // Agent's own messages (starts with "Agent:") and AI messages (starts with "AI:") should be on the right ("sent")
      // Customer messages (others) should be on the left ("received")
      if (msg.sender === username || msg.sender === 'Agent' || msg.sender === 'AI') {
          cls = "sent message";
      } else {
          cls = "received message";
      }

      const div = document.createElement('div');
      div.className = cls;
      div.id = `msg-${messagesData.length - 1}`; // Assign a new unique ID
      div.innerHTML = msg.display_text; // Use display_text from the backend
      div.lang = msg.message_lang; // Set the lang attribute for speech synthesis
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      // No need to reset currentMessageIndex or hide highlight box on new message,
      // as the user might be navigating previous messages.
    });

    // --- Text-to-Speech and Highlight Box Logic ---

    function updateHighlightBox() {
      clearTimeout(speechTimeout); // Clear any existing speech timeout

      if (currentMessageIndex >= 0 && currentMessageIndex < messagesData.length) {
        const currentMessageData = messagesData[currentMessageIndex]; // Get the full message object
        const currentMessageElement = chatBox.querySelector(`#msg-${currentMessageIndex}`); // Get the DOM element

        if (!currentMessageElement || !currentMessageData || !currentMessageData.speech_text) {
            console.warn(`Message element or speech_text not found for index ${currentMessageIndex}.`);
            hideHighlightBox();
            return;
        }

        const chatRect = chatBox.getBoundingClientRect();
        const messageRect = currentMessageElement.getBoundingClientRect();

        highlightBox.style.display = 'block';
        highlightBox.style.width = `${messageRect.width}px`;
        highlightBox.style.height = `${messageRect.height}px`;
        // Position relative to the chatBox's scrollable content
        highlightBox.style.top = `${currentMessageElement.offsetTop}px`;
        highlightBox.style.left = `${currentMessageElement.offsetLeft}px`;


        // Scroll into view if necessary
        currentMessageElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        // Set timeout to read out loud using the stored speech_text
        speechTimeout = setTimeout(() => {
          const messageData = messagesData[currentMessageIndex];
          if (messageData && messageData.speech_text) {
            speakMessage(messageData.speech_text, messageData.message_lang || 'en');
          } else {
            console.warn("No speech_text available for current message.");
          }
        }, SPEECH_DELAY);
      } else {
        hideHighlightBox();
      }
    }

    function hideHighlightBox() {
      highlightBox.style.display = 'none';
      clearTimeout(speechTimeout);
      stopSpeech();
    }

function speakMessage(text, lang) {
  // Telugu fallback: If Telugu requested and not available in browser, use backend TTS
  if (lang === 'te') {
    let browserSupportsTelugu = false;
    if ('speechSynthesis' in window) {
      const voices = window.speechSynthesis.getVoices();
      let match = voices.find(v => v.lang === 'te-IN');
      if (!match) {
        match = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('te'));
      }
      if (match) browserSupportsTelugu = true;
    }
    if (!browserSupportsTelugu) {
      // Use backend TTS for Telugu
      stopSpeech();
      fetch(`${COLAB_URL}/text-to-speech`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, lang: 'te' })
      })
      .then(async response => {
        if (!response.ok) throw new Error('TTS backend error');
        const blob = await response.blob();
        const audioUrl = URL.createObjectURL(blob);
        const audio = new Audio(audioUrl);
        audio.onended = () => { URL.revokeObjectURL(audioUrl); };
        audio.onerror = () => {
          if (typeof showMessageBox === 'function') {
            showMessageBox('Could not play Telugu speech audio.');
          } else {
            alert('Could not play Telugu speech audio.');
          }
        };
        audio.play();
      })
      .catch(err => {
        console.error('TTS backend error:', err);
        if (typeof showMessageBox === 'function') {
          showMessageBox('Telugu speech is not supported in your browser, and the backend TTS is unavailable.');
        } else {
          alert('Telugu speech is not supported in your browser, and the backend TTS is unavailable.');
        }
      });
      return;
    }
    // If browser supports Telugu, fall through to normal speech synthesis below
  }
  if ('speechSynthesis' in window) {
    stopSpeech();
    const utterance = new SpeechSynthesisUtterance(text);
    let targetLang = 'en-US';
    if (lang === 'hi') targetLang = 'hi-IN';
    else if (lang === 'te') targetLang = 'te-IN';
    utterance.lang = targetLang;

    // Try to select a matching voice for the language
    const voices = window.speechSynthesis.getVoices();
    // Debug: List all available voices in the console
    console.log('Available voices:');
    voices.forEach(v => {
      console.log(v.name + ' (' + v.lang + ')' + (v.default ? ' [default]' : ''));
    });
    let match = voices.find(v => v.lang === targetLang);
    // For Telugu, try to find any voice that starts with 'te' (some browsers use te-XX)
    if (!match && lang === 'te') {
      match = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('te'));
    }
    // For Hindi, try to find any voice that starts with 'hi' (some browsers use hi-XX)
    if (!match && lang === 'hi') {
      match = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('hi'));
    }
    if (match) {
      utterance.voice = match;
      window.speechSynthesis.speak(utterance);
    } else if (lang === 'te') {
      // Telugu not supported in browser, use backend TTS fallback
      setTimeout(() => {
        if (typeof showMessageBox === 'function') {
          showMessageBox('Telugu speech is not supported in your browser. Using server TTS.');
        } else {
          alert('Telugu speech is not supported in your browser. Using server TTS.');
        }
      }, 100);
      fetch(COLAB_URL + '/text-to-speech', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, lang: 'te' })
      })
      .then(response => {
        if (!response.ok) throw new Error('TTS server error');
        return response.blob();
      })
      .then(blob => {
        const audioUrl = URL.createObjectURL(blob);
        const audio = new Audio(audioUrl);
        audio.play().catch(err => {
          console.error('Audio playback failed:', err);
        });
      })
      .catch(err => {
        console.error('Backend Telugu TTS failed:', err);
        if (typeof showMessageBox === 'function') {
          showMessageBox('Telugu speech is not available (backend error).');
        } else {
          alert('Telugu speech is not available (backend error).');
        }
      });
    } else if (lang === 'hi') {
      // Hindi not supported, fallback to English and notify
      utterance.lang = 'en-US';
      utterance.voice = voices.find(v => v.lang === 'en-US') || null;
      setTimeout(() => {
        if (typeof showMessageBox === 'function') {
          showMessageBox('Hindi speech is not supported in your browser. Reading in English.');
        } else {
          alert('Hindi speech is not supported in your browser. Reading in English.');
        }
      }, 100);
      window.speechSynthesis.speak(utterance);
    } else {
      // Not Telugu or Hindi, or fallback failed, use default (English)
      window.speechSynthesis.speak(utterance);
    }
  } else {
    // No speech synthesis at all, fallback to backend for Telugu only
    if (lang === 'te') {
      fetch(COLAB_URL + '/text-to-speech', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text, lang: 'te' })
      })
      .then(response => {
        if (!response.ok) throw new Error('TTS server error');
        return response.blob();
      })
      .then(blob => {
        const audioUrl = URL.createObjectURL(blob);
        const audio = new Audio(audioUrl);
        audio.play().catch(err => {
          console.error('Audio playback failed:', err);
        });
      })
      .catch(err => {
        console.error('Backend Telugu TTS failed:', err);
        if (typeof showMessageBox === 'function') {
          showMessageBox('Telugu speech is not available (backend error).');
        } else {
          alert('Telugu speech is not available (backend error).');
        }
      });
    } else {
      console.warn("Speech Synthesis not supported in this browser.");
    }
  }
}


    function stopSpeech() {
      if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      }
    }

    function navigateMessages(direction) {
      stopSpeech(); // Stop speech immediately on navigation
      if (messagesData.length === 0) {
        currentMessageIndex = -1;
        hideHighlightBox();
        return;
      }

      if (direction === 'next') {
        currentMessageIndex = Math.min(currentMessageIndex + 1, messagesData.length - 1);
      } else if (direction === 'prev') {
        currentMessageIndex = Math.max(currentMessageIndex - 1, 0);
      }

      updateHighlightBox();
    }

    function readCustomerList() {
        stopSpeech();
        const customerElements = customersPanel.querySelectorAll('.customer');
        if (customerElements.length === 0) {
            speakMessage("No customers online.", 'en'); // Agent reads in English
            return;
        }
        let customerNames = [];
        customerElements.forEach(customerDiv => {
            customerNames.push(customerDiv.textContent.trim());
        });
        speakMessage("Online customers: " + customerNames.join(", "), 'en'); // Agent reads in English
    }


    function handleKeyboardNavigation(event) {
        // Check if the focus is not on an input field to avoid interfering with typing
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
            return;
        }

        if (event.key === 'ArrowRight') {
            navigateMessages('next');
            event.preventDefault(); // Prevent default scroll behavior
        } else if (event.key === 'ArrowLeft') {
            navigateMessages('prev');
            event.preventDefault(); // Prevent default scroll behavior
        } else if (event.altKey && event.key.toLowerCase() === 'l') { // Alt + L for reading customer list
            if (typeof readCustomerList === 'function') readCustomerList();
            event.preventDefault();
        } else if (event.altKey && event.key.toLowerCase() === 'c') { // Alt + C for reading chat from bottom
            if (messagesData.length > 0) {
                currentMessageIndex = messagesData.length - 1; // Start from the last message
                updateHighlightBox();
            }
            event.preventDefault();
        } else if (event.altKey && event.key.toLowerCase() === 'm') { // Alt + M: Read current message (for both agent and customer)
            if (currentMessageIndex >= 0 && currentMessageIndex < messagesData.length) {
                const msg = messagesData[currentMessageIndex];
                if (msg && msg.speech_text) {
                    speakMessage(msg.speech_text, msg.message_lang || 'en');
                }
            } else if (messagesData.length > 0) {
                // If no message is selected, read the last message
                const msg = messagesData[messagesData.length - 1];
                if (msg && msg.speech_text) {
                    speakMessage(msg.speech_text, msg.message_lang || 'en');
                }
            }
            event.preventDefault();
        }
    }

    function clearChat() {
        if (currentRoom === "") {
            showMessageBox("Please select a customer chat first.");
            return;
        }
        // Clear messages from the UI
        const messagesInChat = chatBox.querySelectorAll('.message');
        for (let i = messagesInChat.length - 1; i >= 0; i--) {
            messagesInChat[i].remove();
        }

        messagesData = []; // Clear the stored messages
        currentMessageIndex = -1; // Reset index
        hideHighlightBox(); // Hide highlight box

        // Emit event to backend to clear chat history in DB
        socket.emit('clear_chat_history', { room: currentRoom });
        showMessageBox("Chat history cleared for " + currentCustomer + ".");
    }

    // Custom message box function (replaces alert)
    function showMessageBox(message) {
        // Create modal container
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '1000';

        // Create modal content box
        const modalContent = document.createElement('div');
        modalContent.style.backgroundColor = '#fff';
        modalContent.style.padding = '25px';
        modalContent.style.borderRadius = '10px';
        modalContent.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
        modalContent.style.textAlign = 'center';
        modalContent.style.maxWidth = '400px';
        modalContent.style.width = '90%';

        // Message text
        const messageText = document.createElement('p');
        messageText.innerText = message;
        messageText.style.marginBottom = '20px';
        messageText.style.fontSize = '1.1em';
        messageText.style.color = '#333';

        // OK button
        const okButton = document.createElement('button');
        okButton.innerText = 'OK';
        okButton.style.padding = '10px 20px';
        okButton.style.backgroundColor = '#007bff';
        okButton.style.color = 'white';
        okButton.style.border = 'none';
        okButton.style.borderRadius = '5px';
        okButton.style.cursor = 'pointer';
        okButton.style.fontSize = '1em';
        okButton.addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        modalContent.appendChild(messageText);
        modalContent.appendChild(okButton);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
    }

    // Remove unused highlightCustomer and customer-list-item code

    // --- Fix: Speak customer name on arrow navigation after Alt+L ---
    // This logic is integrated with the main keyboard navigation above
    // (see: Alt+L, ArrowUp, ArrowDown in the main document.addEventListener('keydown', ...))
    // We'll ensure the customer name is spoken every time the highlight changes
    // by calling speakMessage in the ArrowUp/ArrowDown blocks.
  </script>
<footer style="margin-top:40px;text-align:center;color:#888;font-size:1em;">Powered by travis g424</footer>
</body>
</html>
